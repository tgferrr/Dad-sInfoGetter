<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Tempo Jogado - Roblox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2575fc;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
        }
        .progress {
            height: 10px;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .api-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        .api-error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>Análise de Tempo Jogado - Roblox</h1>
            <p class="mb-0">Relatório de tempo jogado baseado nos dados da API</p>
        </div>

        <div id="api-status">
            <div class="api-status">
                <i class="bi bi-info-circle"></i> 
                Conectando diretamente à API: http://201.23.67.218:8000/
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Filtros</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="start-date" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="start-date" value="2025-08-01">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="end-date" value="2025-08-30">
                    </div>
                    <div class="col-md-3">
                        <label for="user-filter" class="form-label">Usuário</label>
                        <select class="form-select" id="user-filter">
                            <option value="all">Todos os usuários</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadData()">
                            <i class="bi bi-arrow-clockwise"></i> Carregar Dados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="card loading" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Carregando dados da API...</p>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div id="stats-container" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value" id="total-time">0h 0min</div>
                        <div class="stat-label">Tempo Total</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value" id="total-days">0</div>
                        <div class="stat-label">Dias com Atividade</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value" id="avg-time">0h 0min</div>
                        <div class="stat-label">Tempo Médio</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value" id="max-time">0h 0min</div>
                        <div class="stat-label">Máximo por Dia</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tempo Jogado por Dia</h5>
                    <div class="table-responsive">
                        <table class="table table-hover" id="time-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Usuário</th>
                                    <th>Tempo Jogado</th>
                                    <th>Progresso</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração inicial
        document.getElementById('end-date').valueAsDate = new Date();
        
        // Função para carregar dados da API
        async function loadData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const userFilter = document.getElementById('user-filter').value;
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('stats-container').style.display = 'none';
            
            try {
                // Atualizar status da API
                document.getElementById('api-status').innerHTML = '<div class="api-status">Conectando à API...</div>';
                
                // Fazer requisição diretamente para a API
                // NOTA: Isso pode falhar devido a políticas CORS
                const apiUrl = `http://201.23.67.218:8000/export-xlsx?start=${startDate}&end=${endDate}&online_only=true`;
                
                // Tentativa 1: Usando fetch com mode 'no-cors' (limita o acesso à resposta)
                let response;
                try {
                    response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        },
                        mode: 'cors' // Tenta primeiro com CORS
                    });
                } catch (corsError) {
                    // Se falhar devido a CORS, tenta com mode 'no-cors'
                    console.log('Tentando com mode no-cors devido a erro CORS:', corsError);
                    response = await fetch(apiUrl, {
                        method: 'GET',
                        mode: 'no-cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    // Modo no-cors não permite acesso à resposta, então precisamos de uma abordagem alternativa
                    document.getElementById('api-status').innerHTML = '<div class="api-status api-error">Erro de CORS. Tentando abordagem alternativa...</div>';
                    
                    // Abordagem alternativa: usar um proxy CORS simples via JavaScript
                    await loadWithCorsProxy(apiUrl, userFilter);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Atualizar status da API
                document.getElementById('api-status').innerHTML = `<div class="api-status api-success"><i class="bi bi-check-circle-fill"></i> Dados carregados com sucesso! ${data.length || (data.data ? data.data.length : 0)} registros encontrados.</div>`;
                
                // Processar dados
                processData(data, userFilter);
                
            } catch (error) {
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('loading').style.display = 'none';
                
                // Atualizar status da API
                document.getElementById('api-status').innerHTML = `<div class="api-status api-error"><i class="bi bi-x-circle-fill"></i> Erro: ${error.message}</div>`;
            }
        }

        // Função alternativa para contornar CORS usando um proxy
        async function loadWithCorsProxy(apiUrl, userFilter) {
            try {
                // Usando um proxy CORS público
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                
                if (!response.ok) {
                    throw new Error(`Erro no proxy CORS: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Atualizar status da API
                document.getElementById('api-status').innerHTML = `<div class="api-status api-success"><i class="bi bi-check-circle-fill"></i> Dados carregados via proxy! ${data.length || (data.data ? data.data.length : 0)} registros encontrados.</div>`;
                
                // Processar dados
                processData(data, userFilter);
            } catch (proxyError) {
                // Se tudo falhar, usar dados de exemplo
                document.getElementById('api-status').innerHTML = `<div class="api-status api-error"><i class="bi bi-exclamation-triangle"></i> Erro ao acessar a API: ${proxyError.message}. Mostrando dados de exemplo.</div>`;
                
                // Dados de exemplo para demonstração
                const sampleData = getSampleData();
                processData(sampleData, userFilter);
            }
        }

        // Função para gerar dados de exemplo
        function getSampleData() {
            return [
                {
                    timestamp: "2025-08-15T18:50:02.509486",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "DOORS 👁 [🌐]"
                },
                {
                    timestamp: "2025-08-15T18:51:02.706112",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[ACTUALIZAÇÃO!] Campo de Batalha"
                },
                {
                    timestamp: "2025-08-15T19:11:02.748878",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[🎣] 99 noites na floresta 🔦"
                },
                {
                    timestamp: "2025-08-16T11:50:02.586553",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[ACTUALIZAÇÃO!] Campo de Batalha"
                },
                {
                    timestamp: "2025-08-17T23:10:02.636693",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[🎣] 99 noites na floresta 🔦"
                },
                {
                    timestamp: "2025-08-18T21:00:03.145590",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[99 Noites no MODDED]"
                },
                {
                    timestamp: "2025-08-18T23:17:02.312298",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[ACTUALIZAÇÃO!] Campo de Batalha"
                },
                {
                    timestamp: "2025-08-19T22:40:02.542496",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[🎣] 99 noites na floresta 🔦"
                },
                {
                    timestamp: "2025-08-20T18:50:02.935949",
                    userId: 9005903,
                    userName: "Hugo",
                    status: "Jogando",
                    gameName: "[🎣] 99 noites na floresta 🔦"
                }
            ];
        }

        // Função para processar os dados e calcular o tempo jogado
        function processData(data, userFilter) {
            // Agrupar registros por usuário e por dia
            const recordsByDayAndUser = {};
            const users = new Set();
            
            // Verificar estrutura dos dados
            let records = [];
            if (Array.isArray(data)) {
                records = data;
            } else if (data && Array.isArray(data.data)) {
                records = data.data;
            } else {
                throw new Error('Formato de dados não reconhecido');
            }
            
            records.forEach(record => {
                if (record.status === 'Jogando') {
                    const timestamp = new Date(record.timestamp);
                    const dateKey = timestamp.toISOString().split('T')[0];
                    const userId = record.userId;
                    const userName = record.userName || `Usuário ${userId}`;
                    
                    users.add(userId);
                    
                    if (!recordsByDayAndUser[dateKey]) {
                        recordsByDayAndUser[dateKey] = {};
                    }
                    
                    if (!recordsByDayAndUser[dateKey][userId]) {
                        recordsByDayAndUser[dateKey][userId] = {
                            name: userName,
                            timestamps: []
                        };
                    }
                    
                    recordsByDayAndUser[dateKey][userId].timestamps.push(timestamp);
                }
            });
            
            // Preencher filtro de usuários
            const userFilterElement = document.getElementById('user-filter');
            if (userFilterElement.options.length === 1) { // Apenas "Todos" existe
                users.forEach(userId => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = `Usuário ${userId}`;
                    userFilterElement.appendChild(option);
                });
            }
            
            // Calcular tempo jogado por dia para cada usuário
            const results = [];
            let totalTimeMs = 0;
            let maxTimeMs = 0;
            
            Object.keys(recordsByDayAndUser).sort().forEach(date => {
                Object.keys(recordsByDayAndUser[date]).forEach(userId => {
                    // Aplicar filtro de usuário
                    if (userFilter !== 'all' && userFilter !== userId) {
                        return;
                    }
                    
                    const userData = recordsByDayAndUser[date][userId];
                    const timestamps = userData.timestamps.sort((a, b) => a - b);
                    
                    let totalTimeUserMs = 0;
                    
                    for (let i = 0; i < timestamps.length - 1; i++) {
                        const diff = timestamps[i + 1] - timestamps[i];
                        
                        // Lógica do cron: se diferença for ≈1 minuto, conta como tempo jogado
                        if (diff >= 50000 && diff <= 70000) { // 50-70 segundos
                            totalTimeUserMs += diff;
                        }
                    }
                    
                    // Se só tem um registro no dia, conta 1 minuto
                    if (timestamps.length === 1) {
                        totalTimeUserMs = 60000;
                    }
                    
                    // Adicionar último minuto (último registro)
                    totalTimeUserMs += 60000;
                    
                    totalTimeMs += totalTimeUserMs;
                    maxTimeMs = Math.max(maxTimeMs, totalTimeUserMs);
                    
                    const hours = Math.floor(totalTimeUserMs / 3600000);
                    const minutes = Math.floor((totalTimeUserMs % 3600000) / 60000);
                    
                    results.push({
                        date,
                        userId,
                        userName: userData.name,
                        timeMs: totalTimeUserMs,
                        displayTime: `${hours}h ${minutes}min`
                    });
                });
            });
            
            // Atualizar estatísticas
            const totalHours = Math.floor(totalTimeMs / 3600000);
            const totalMinutes = Math.floor((totalTimeMs % 3600000) / 60000);
            document.getElementById('total-time').textContent = `${totalHours}h ${totalMinutes}min`;
            
            document.getElementById('total-days').textContent = results.length;
            
            const avgTimeMs = results.length > 0 ? totalTimeMs / results.length : 0;
            const avgHours = Math.floor(avgTimeMs / 3600000);
            const avgMinutes = Math.floor((avgTimeMs % 3600000) / 60000);
            document.getElementById('avg-time').textContent = `${avgHours}h ${avgMinutes}min`;
            
            const maxHours = Math.floor(maxTimeMs / 3600000);
            const maxMinutes = Math.floor((maxTimeMs % 3600000) / 60000);
            document.getElementById('max-time').textContent = `${maxHours}h ${maxMinutes}min`;
            
            // Preencher tabela
            const tableBody = document.querySelector('#time-table tbody');
            tableBody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = new Date(result.date).toLocaleDateString('pt-BR');
                
                const userCell = document.createElement('td');
                userCell.textContent = result.userName;
                
                const timeCell = document.createElement('td');
                timeCell.textContent = result.displayTime;
                
                const progressCell = document.createElement('td');
                const progressBar = document.createElement('div');
                progressBar.className = 'progress';
                
                const progressFill = document.createElement('div');
                progressFill.className = 'progress-bar';
                progressFill.style.width = `${Math.min(100, (result.timeMs / maxTimeMs) * 100)}%`;
                
                progressBar.appendChild(progressFill);
                progressCell.appendChild(progressBar);
                
                row.appendChild(dateCell);
                row.appendChild(userCell);
                row.appendChild(timeCell);
                row.appendChild(progressCell);
                
                tableBody.appendChild(row);
            });
            
            // Esconder loading e mostrar resultados
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats-container').style.display = 'block';
        }

        // Carregar dados ao iniciar
        window.onload = function() {
            // Tentar carregar dados reais automaticamente
            loadData();
        };
    </script>
</body>
</html>